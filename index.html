<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camino</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #ffffff;
  --ink: #111111;
  --muted: #999;
  --border: #ebebeb;
  --hover: #f7f7f7;
  --tag: #f2f2f2;
  --radius: 6px;
}

html, body { height: 100%; overflow: hidden; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Inter', -apple-system, sans-serif;
  font-size: 13px;
}

/* ══ HEADER ══ */
header {
  height: 48px;
  display: flex;
  align-items: center;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.logo {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
}
.logo-dot { color: #ccc; margin: 0 3px; }
.header-sub { font-size: 11px; color: var(--muted); }

/* ══ DESKTOP LAYOUT ══ */
main {
  display: grid;
  grid-template-columns: 1fr 260px;
  height: calc(100vh - 48px);
}

/* ── Canvas ── */
.canvas-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px 28px;
  overflow: hidden;
}

.drop-zone {
  width: 100%; height: 100%;
  max-height: calc(100vh - 48px - 56px);
  border: 1.5px dashed #ddd;
  border-radius: var(--radius);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  cursor: pointer; gap: 8px;
  transition: border-color 0.15s, background 0.15s;
}
.drop-zone:hover, .drop-zone.over { border-color: var(--ink); background: var(--hover); }
.drop-icon {
  width: 36px; height: 36px;
  border: 1.5px solid #ddd; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; color: #ccc; margin-bottom: 4px;
}
.drop-text { font-size: 12px; color: var(--muted); }
.drop-text em { color: var(--ink); font-style: normal; }
.drop-hint { font-size: 10px; color: #ccc; letter-spacing: 0.5px; }
#fileInput { display: none; }

.preview-wrap {
  display: none; flex-direction: column;
  align-items: center; gap: 12px;
  width: 100%; height: 100%;
}
.preview-wrap.on { display: flex; }
.drop-zone.hidden { display: none; }

canvas {
  max-width: 100%;
  max-height: calc(100vh - 48px - 80px);
  width: auto; height: auto;
  display: block;
  border-radius: 3px;
  box-shadow: 0 2px 20px rgba(0,0,0,0.08);
  flex-shrink: 1;
  min-height: 0;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}

/* Hold-to-preview badge */
.preview-wrap { position: relative; }
.hold-hint {
  position: absolute;
  top: 10px; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.55);
  color: #fff;
  font-size: 11px;
  letter-spacing: 0.3px;
  padding: 5px 12px;
  border-radius: 20px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  white-space: nowrap;
  z-index: 10;
}
.hold-hint.visible { opacity: 1; }
.hold-hint.showing-original {
  background: rgba(0,0,0,0.75);
}

.actions {
  display: flex; gap: 8px; flex-shrink: 0;
}
.btn {
  height: 34px; padding: 0 16px;
  border: 1px solid var(--border); background: none;
  font-family: 'Inter', sans-serif; font-size: 11px;
  font-weight: 400; color: var(--muted);
  cursor: pointer; border-radius: var(--radius);
  transition: all 0.12s; white-space: nowrap;
}
.btn:hover { border-color: #bbb; color: var(--ink); }
.btn.primary { background: var(--ink); color: #fff; border-color: var(--ink); }
.btn.primary:hover { background: #333; }

/* ── Sidebar (desktop) ── */
.sidebar {
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow-y: auto; background: #fff;
}
.sb-section { padding: 16px 16px 0; }
.sb-section:last-child { padding-bottom: 16px; }
.sb-label {
  font-size: 10px; font-weight: 500;
  letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 8px;
}
.active-tag {
  display: inline-flex; align-items: center;
  gap: 6px; font-size: 12px; color: var(--ink);
}
.active-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--ink); flex-shrink: 0;
}
.filter-list { display: flex; flex-direction: column; gap: 2px; }
.filter-pill {
  display: flex; align-items: center; justify-content: space-between;
  height: 32px; padding: 0 10px; border-radius: 5px;
  border: 1px solid transparent; cursor: pointer;
  transition: all 0.1s; font-size: 12px; color: var(--ink);
}
.filter-pill:hover { background: var(--hover); }
.filter-pill.active { background: var(--ink); color: #fff; }
.pill-tag { font-size: 10px; color: var(--muted); }
.filter-pill.active .pill-tag { color: rgba(255,255,255,0.4); }

.sb-divider { height: 1px; background: var(--border); margin: 12px 0 0; }

.adjust-toggle {
  width: 100%; height: 32px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 10px; background: var(--tag);
  border: 1px solid var(--border); border-radius: 5px;
  font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 500;
  color: var(--ink); cursor: pointer; transition: all 0.12s;
}
.adjust-toggle:hover { background: #e8e8e8; }
.adjust-toggle.open { background: var(--ink); color: #fff; border-color: var(--ink); }
.toggle-arrow { font-size: 9px; transition: transform 0.2s; }
.adjust-toggle.open .toggle-arrow { transform: rotate(180deg); }

.slider-panel { display: none; flex-direction: column; padding-top: 12px; }
.slider-panel.open { display: flex; }
.slider-group { margin-bottom: 14px; }
.slider-group-label {
  font-size: 10px; font-weight: 500; letter-spacing: 1px;
  text-transform: uppercase; color: #bbb; margin-bottom: 8px;
}
.sl-row { margin-bottom: 10px; }
.sl-row:last-child { margin-bottom: 0; }
.sl-head {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 5px; font-size: 11px; color: var(--muted);
}
.sl-head b { color: var(--ink); font-weight: 400; font-size: 11px; }

input[type=range] {
  -webkit-appearance: none; width: 100%; height: 2px;
  background: var(--border); border-radius: 2px; outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 16px; height: 16px;
  background: #fff; border: 1.5px solid var(--ink);
  border-radius: 50%; cursor: pointer;
}
#temp { background: linear-gradient(to right, #a8c8e8, var(--border) 50%, #e8b87a); }

/* ══ MOBILE ══ */
@media (max-width: 640px) {
  /* 하단 패널 높이 변수 — 필터칩 + 강도슬라이더 + safe area */
  :root { --bottom-panel: 130px; }

  html, body {
    height: 100dvh;
    overflow: hidden;
  }

  main {
    display: flex;
    flex-direction: column;
    grid-template-columns: unset;
    height: calc(100dvh - 48px);
  }

  /* ① 사진 영역 — 하단 패널 빼고 남은 공간 전부 */
  .canvas-area {
    flex: 1;
    min-height: 0;          /* flex child가 줄어들 수 있게 */
    padding: 12px 12px 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: #f6f6f6;
  }

  .drop-zone {
    width: 100%;
    flex: 1;
    min-height: 0;
    max-height: none;
    border-radius: 12px;
    border: 1.5px dashed #d0d0d0;
  }

  canvas {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.10);
    flex-shrink: 1;
    object-fit: contain;
  }

  .preview-wrap {
    width: 100%;
    flex: 1;
    min-height: 0;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    overflow: hidden;
  }
  .preview-wrap.on { display: flex; }

  .actions {
    flex-shrink: 0;
    gap: 6px;
  }
  .btn { height: 34px; font-size: 12px; padding: 0 14px; }

  /* ② 하단 패널 — 고정 높이 */
  .sidebar {
    flex-shrink: 0;
    height: var(--bottom-panel);
    border-left: none;
    border-top: 1px solid var(--border);
    overflow: visible;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: #fff;
  }

  /* 데스크탑 전용 요소 숨기기 */
  .desktop-only { display: none !important; }
  .sb-section:first-child { display: none; }
  .sb-divider { display: none; }
  .sb-section:not(:first-child) { display: none; }

  /* 모바일 전용 영역만 보이게 */
  #mobileFilterSection { display: flex !important; flex-direction: column; }

  /* 필터 가로 스크롤 칩 */
  .filter-section-mobile {
    padding: 10px 0 0;
    flex-shrink: 0;
  }
  .filter-scroll {
    display: flex;
    overflow-x: auto;
    gap: 6px;
    padding: 0 14px 0;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  .filter-scroll::-webkit-scrollbar { display: none; }

  /* 강도 + 조절 버튼 한 줄 */
  .mobile-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 14px 0;
    flex-shrink: 0;
  }
  .mobile-intensity {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
  }
  .mobile-intensity input { flex: 1; }

  /* 바텀 시트 */
  .mobile-sheet-backdrop {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.25);
    z-index: 100;
  }
  .mobile-sheet-backdrop.open { display: block; }

  .mobile-sheet {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #fff;
    border-radius: 20px 20px 0 0;
    padding: 0 20px env(safe-area-inset-bottom, 20px);
    padding-bottom: max(env(safe-area-inset-bottom), 24px);
    z-index: 101;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    max-height: 75dvh;
    overflow-y: auto;
  }
  .mobile-sheet.open { transform: translateY(0); }

  .sheet-handle {
    width: 36px; height: 4px;
    background: #e0e0e0; border-radius: 2px;
    margin: 12px auto 16px;
  }
  .sheet-title {
    font-size: 15px; font-weight: 600;
    margin-bottom: 20px; color: var(--ink);
  }

  .adjust-toggle {
    height: 32px; font-size: 11px;
    white-space: nowrap; flex-shrink: 0;
    width: auto; padding: 0 12px;
  }
}
</style>
</head>
<body>

<header>
  <div class="logo">Camino</div>
  <div class="logo-dot">·</div>
  <div class="header-sub">Photo Filter Studio</div>
</header>

<main>
  <!-- CANVAS -->
  <div class="canvas-area">
    <div class="drop-zone" id="dropZone">
      <div class="drop-icon">↑</div>
      <div class="drop-text">드래그하거나 <em>클릭</em>해서 업로드</div>
      <div class="drop-hint">JPG · PNG · WEBP</div>
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <div class="preview-wrap" id="previewWrap">
      <div class="hold-hint" id="holdHint">꾹 누르면 원본 보기</div>
      <canvas id="canvas"></canvas>
      <div class="actions">
        <button class="btn" id="resetBtn">초기화</button>
        <button class="btn" id="changeBtn">사진 변경</button>
        <button class="btn primary" id="dlBtn">↓ 저장</button>
      </div>
    </div>
  </div>

  <!-- SIDEBAR (desktop) -->
  <div class="sidebar">
    <div class="sb-section">
      <div class="sb-label">현재 필터</div>
      <div class="active-tag">
        <div class="active-dot"></div>
        <span id="activeName">없음</span>
      </div>
    </div>

    <div class="sb-divider"></div>

    <div class="sb-section desktop-only" style="padding-top:14px">
      <div class="sb-label">필터</div>
      <div class="filter-list" id="filterList"></div>
    </div>

    <div class="sb-divider desktop-only"></div>

    <div class="sb-section" style="padding-top:14px; padding-bottom:14px;">
      <div class="sb-label">필터 강도</div>
      <div class="sl-row" style="margin-bottom:0">
        <div class="sl-head">강도 <b id="intensityVal">100%</b></div>
        <input type="range" id="intensity" min="0" max="100" value="100">
      </div>
    </div>

    <div class="sb-divider"></div>

    <div class="sb-section" style="padding-top:14px; padding-bottom:16px;">
      <button class="adjust-toggle" id="adjustBtn">
        세부 조절
        <span class="toggle-arrow">▾</span>
      </button>
      <div class="slider-panel" id="sliderPanel">
        <div class="slider-group">
          <div class="slider-group-label">밝기 · 색상</div>
          <div class="sl-row">
            <div class="sl-head">밝기 <b id="bVal">0</b></div>
            <input type="range" id="brightness" min="-100" max="100" value="0">
          </div>
          <div class="sl-row">
            <div class="sl-head">대비 <b id="cVal">0</b></div>
            <input type="range" id="contrast" min="-100" max="100" value="0">
          </div>
          <div class="sl-row">
            <div class="sl-head">채도 <b id="sVal">0</b></div>
            <input type="range" id="saturation" min="-100" max="100" value="0">
          </div>
          <div class="sl-row">
            <div class="sl-head">노출 <b id="eVal">0</b></div>
            <input type="range" id="exposure" min="-100" max="100" value="0">
          </div>
        </div>
        <div class="slider-group">
          <div class="slider-group-label">포커스</div>
          <div class="sl-row">
            <div class="sl-head">블러 <b id="blVal">0</b></div>
            <input type="range" id="blur" min="0" max="20" value="0">
          </div>
          <div class="sl-row">
            <div class="sl-head">선명도 <b id="shVal">0</b></div>
            <input type="range" id="sharpen" min="0" max="100" value="0">
          </div>
        </div>
        <div class="slider-group" style="margin-bottom:0">
          <div class="slider-group-label">색온도</div>
          <div class="sl-row" style="margin-bottom:0">
            <div class="sl-head">
              <span style="color:#7ab4d8; font-size:10px">차가움</span>
              <b id="tempVal">0</b>
              <span style="color:#d4895a; font-size:10px">따뜻함</span>
            </div>
            <input type="range" id="temp" min="-100" max="100" value="0">
          </div>
        </div>
      </div>
    </div>

    <!-- MOBILE: filter chips + intensity + adjust button -->
    <div class="filter-section-mobile" style="display:none" id="mobileFilterSection">
      <div class="filter-scroll" id="mobileFilterList"></div>
      <div class="mobile-controls">
        <div class="mobile-intensity">
          <span>강도</span>
          <input type="range" id="intensityMobile" min="0" max="100" value="100">
          <b id="intensityValMobile" style="min-width:28px;text-align:right;color:#111">100%</b>
        </div>
        <button class="adjust-toggle" id="adjustBtnMobile" style="width:auto;padding:0 12px;flex-shrink:0">
          조절 <span class="toggle-arrow" id="mobileArrow">▾</span>
        </button>
      </div>
    </div>
  </div>
</main>

<!-- MOBILE BOTTOM SHEET -->
<div class="mobile-sheet-backdrop" id="sheetBackdrop"></div>
<div class="mobile-sheet" id="mobileSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-title">세부 조절</div>
  <div class="slider-group">
    <div class="slider-group-label">밝기 · 색상</div>
    <div class="sl-row">
      <div class="sl-head">밝기 <b id="bValM">0</b></div>
      <input type="range" id="brightnessM" min="-100" max="100" value="0">
    </div>
    <div class="sl-row">
      <div class="sl-head">대비 <b id="cValM">0</b></div>
      <input type="range" id="contrastM" min="-100" max="100" value="0">
    </div>
    <div class="sl-row">
      <div class="sl-head">채도 <b id="sValM">0</b></div>
      <input type="range" id="saturationM" min="-100" max="100" value="0">
    </div>
    <div class="sl-row">
      <div class="sl-head">노출 <b id="eValM">0</b></div>
      <input type="range" id="exposureM" min="-100" max="100" value="0">
    </div>
  </div>
  <div class="slider-group">
    <div class="slider-group-label">포커스</div>
    <div class="sl-row">
      <div class="sl-head">블러 <b id="blValM">0</b></div>
      <input type="range" id="blurM" min="0" max="20" value="0">
    </div>
    <div class="sl-row">
      <div class="sl-head">선명도 <b id="shValM">0</b></div>
      <input type="range" id="sharpenM" min="0" max="100" value="0">
    </div>
  </div>
  <div class="slider-group" style="margin-bottom:0">
    <div class="slider-group-label">색온도</div>
    <div class="sl-row" style="margin-bottom:0">
      <div class="sl-head">
        <span style="color:#7ab4d8;font-size:10px">차가움</span>
        <b id="tempValM">0</b>
        <span style="color:#d4895a;font-size:10px">따뜻함</span>
      </div>
      <input type="range" id="tempM" min="-100" max="100" value="0" style="background: linear-gradient(to right, #a8c8e8, #ebebeb 50%, #e8b87a)">
    </div>
  </div>
</div>

<script>
// ── MOBILE DETECTION & INIT ──
const isMobile = () => window.innerWidth <= 640;

function initMobileUI() {
  if (!isMobile()) return;
  // Show mobile filter section, hide desktop filter list label area
  document.getElementById('mobileFilterSection').style.display = 'block';

  // Build mobile filter chips
  const mobileList = document.getElementById('mobileFilterList');
  FILTERS.forEach(f => {
    const chip = document.createElement('div');
    chip.dataset.id = f.id;
    chip.style.cssText = `
      flex-shrink:0; height:32px; padding:0 12px;
      border-radius:20px; border:1px solid #e0e0e0;
      display:flex; align-items:center; gap:5px;
      font-size:12px; cursor:pointer; white-space:nowrap;
      transition:all 0.1s; background:#fff; color:#111;
    `;
    chip.innerHTML = `<span>${f.name}</span>`;
    if (f.id === 'none') {
      chip.style.background = '#111';
      chip.style.color = '#fff';
      chip.style.borderColor = '#111';
    }
    chip.addEventListener('click', () => pickFilter(f.id));
    mobileList.appendChild(chip);
  });
}

function updateMobileChips(activeId) {
  document.querySelectorAll('#mobileFilterList [data-id]').forEach(chip => {
    const isActive = chip.dataset.id === activeId;
    chip.style.background = isActive ? '#111' : '#fff';
    chip.style.color = isActive ? '#fff' : '#111';
    chip.style.borderColor = isActive ? '#111' : '#e0e0e0';
  });
  // Scroll active chip into view
  const active = document.querySelector(`#mobileFilterList [data-id="${activeId}"]`);
  if (active) active.scrollIntoView({ inline: 'center', block: 'nearest', behavior: 'smooth' });
}

// Mobile bottom sheet
function openSheet() {
  document.getElementById('sheetBackdrop').classList.add('open');
  document.getElementById('mobileSheet').classList.add('open');
  document.getElementById('mobileArrow').style.transform = 'rotate(180deg)';
}
function closeSheet() {
  document.getElementById('sheetBackdrop').classList.remove('open');
  document.getElementById('mobileSheet').classList.remove('open');
  document.getElementById('mobileArrow').style.transform = '';
}

document.getElementById('adjustBtnMobile').addEventListener('click', () => {
  const sheet = document.getElementById('mobileSheet');
  sheet.classList.contains('open') ? closeSheet() : openSheet();
});
document.getElementById('sheetBackdrop').addEventListener('click', closeSheet);

// Mobile intensity slider (mirrors desktop)
document.getElementById('intensityMobile').addEventListener('input', function() {
  document.getElementById('intensityValMobile').textContent = this.value + '%';
  document.getElementById('intensity').value = this.value;
  document.getElementById('intensityVal').textContent = this.value + '%';
  render();
});

// Mobile sheet sliders — each mirrors desktop slider
const mobileSliderMap = {
  brightnessM: ['brightness','bVal','bValM'],
  contrastM:   ['contrast','cVal','cValM'],
  saturationM: ['saturation','sVal','sValM'],
  exposureM:   ['exposure','eVal','eValM'],
  blurM:       ['blur','blVal','blValM'],
  sharpenM:    ['sharpen','shVal','shValM'],
  tempM:       ['temp','tempVal','tempValM'],
};
Object.entries(mobileSliderMap).forEach(([mId, [dId, dVal, mVal]]) => {
  document.getElementById(mId).addEventListener('input', function() {
    document.getElementById(mVal).textContent = this.value;
    document.getElementById(dId).value = this.value;
    document.getElementById(dVal).textContent = this.value;
    render();
  });
});

function syncMobileSliders() {
  // Sync mobile sheet sliders to match desktop values
  Object.entries(mobileSliderMap).forEach(([mId, [dId, , mVal]]) => {
    const val = document.getElementById(dId).value;
    document.getElementById(mId).value = val;
    document.getElementById(mVal).textContent = val;
  });
  const intVal = document.getElementById('intensity').value;
  document.getElementById('intensityMobile').value = intVal;
  document.getElementById('intensityValMobile').textContent = intVal + '%';
}

const FILTERS = [
  { id: 'none',      name: '원본',        tag: 'base',  css: '' },
  { id: 'rosemilk',  name: 'Rose Milk',   tag: 'warm',  css: '__pixel__' },
  { id: 'sunshine',  name: 'Sunshine',    tag: 'warm',  css: '__pixel__' },
  { id: 'kodak',     name: 'Kodak Gold',  tag: 'film',  css: 'sepia(0.25) saturate(1.4) brightness(1.05) contrast(1.08) hue-rotate(-5deg)' },
  { id: 'fuji',      name: 'Fuji Pro',    tag: 'film',  css: 'saturate(1.3) hue-rotate(5deg) brightness(1.02) contrast(0.95)' },
  { id: 'portra',    name: 'Portra 400',  tag: 'film',  css: 'sepia(0.1) saturate(0.9) brightness(1.1) contrast(0.92) hue-rotate(-8deg)' },
  { id: 'fujitra',   name: 'Flowers',     tag: 'film',  css: 'saturate(1.1) hue-rotate(-1deg) brightness(1.06) contrast(0.935) sepia(0.05)' },
  { id: 'dawn',      name: 'Dawn',        tag: 'mood',  css: '__pixel__' },
  { id: 'winter',    name: 'Winter',      tag: 'mood',  css: '__pixel__' },
  { id: 'ilford',    name: 'Ilford HP5',  tag: 'b&w',   css: 'grayscale(1) contrast(1.15) brightness(1.02)' },
  { id: 'trix',      name: 'Tri-X 400',   tag: 'b&w',   css: 'grayscale(1) contrast(1.35) brightness(0.95)' },
  { id: 'fade',      name: 'Faded',       tag: 'mood',  css: 'contrast(0.85) brightness(1.08) saturate(0.7)' },
  { id: 'y2kdigi',   name: 'Y2K Digi',    tag: '2000s', css: '__pixel__' },
];

const PIXEL_FILTERS = ['rosemilk', 'sunshine', 'dawn', 'winter', 'y2kdigi'];
let activeFilter = 'none';
let originalImg = null;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const holdHint = document.getElementById('holdHint');
const dropZone = document.getElementById('dropZone');

// ── HOLD TO PREVIEW ORIGINAL ──
let holdTimer = null;
let isHolding = false;

function showOriginal() {
  if (!originalImg || activeFilter === 'none') return;
  isHolding = true;
  // Draw raw original with no filter
  ctx.clearRect(0, 0, originalImg._w, originalImg._h);
  ctx.filter = 'none';
  ctx.drawImage(originalImg, 0, 0, originalImg._w, originalImg._h);
  canvas.style.filter = 'none';
  holdHint.textContent = '원본';
  holdHint.classList.add('showing-original');
}

function restoreFilter() {
  if (!isHolding) return;
  isHolding = false;
  clearTimeout(holdTimer);
  render();
  holdHint.textContent = '꾹 누르면 원본 보기';
  holdHint.classList.remove('showing-original');
}

function onHoldStart(e) {
  if (!originalImg || activeFilter === 'none') return;
  e.preventDefault();
  holdHint.classList.add('visible');
  holdTimer = setTimeout(showOriginal, 180);
}

function onHoldEnd() {
  clearTimeout(holdTimer);
  holdHint.classList.remove('visible');
  restoreFilter();
}

canvas.addEventListener('mousedown', onHoldStart);
canvas.addEventListener('mouseup', onHoldEnd);
canvas.addEventListener('mouseleave', onHoldEnd);
canvas.addEventListener('touchstart', onHoldStart, { passive: false });
canvas.addEventListener('touchend', onHoldEnd);
canvas.addEventListener('touchcancel', onHoldEnd);

// Show hint briefly when filter is first applied
function showHoldHint() {
  if (!originalImg) return;
  holdHint.classList.add('visible');
  setTimeout(() => {
    if (!isHolding) holdHint.classList.remove('visible');
  }, 1800);
}
const fileInput = document.getElementById('fileInput');
const previewWrap = document.getElementById('previewWrap');
const filterList = document.getElementById('filterList');

// Build filter list
FILTERS.forEach(f => {
  const el = document.createElement('div');
  el.className = 'filter-pill' + (f.id === 'none' ? ' active' : '');
  el.dataset.id = f.id;
  el.innerHTML = `<span>${f.name}</span><span class="pill-tag">${f.tag}</span>`;
  el.addEventListener('click', () => pickFilter(f.id));
  filterList.appendChild(el);
});

// ── SLIDERS ──
function getSliders() {
  return {
    b:         parseFloat(document.getElementById('brightness').value),
    c:         parseFloat(document.getElementById('contrast').value),
    s:         parseFloat(document.getElementById('saturation').value),
    e:         parseFloat(document.getElementById('exposure').value),
    bl:        parseFloat(document.getElementById('blur').value),
    sh:        parseFloat(document.getElementById('sharpen').value),
    temp:      parseFloat(document.getElementById('temp').value),
    intensity: parseFloat(document.getElementById('intensity').value) / 100,
  };
}

function resetSliders() {
  const map = { brightness:'bVal', contrast:'cVal', saturation:'sVal', exposure:'eVal', blur:'blVal', sharpen:'shVal', temp:'tempVal' };
  Object.keys(map).forEach(id => {
    document.getElementById(id).value = 0;
    document.getElementById(map[id]).textContent = '0';
  });
  document.getElementById('intensity').value = 100;
  document.getElementById('intensityVal').textContent = '100%';
  syncMobileSliders();
}

const sliderMap = { brightness:'bVal', contrast:'cVal', saturation:'sVal', exposure:'eVal', blur:'blVal', sharpen:'shVal', temp:'tempVal' };
Object.keys(sliderMap).forEach(id => {
  document.getElementById(id).addEventListener('input', function() {
    document.getElementById(sliderMap[id]).textContent = this.value;
    render();
  });
});
document.getElementById('intensity').addEventListener('input', function() {
  document.getElementById('intensityVal').textContent = this.value + '%';
  render();
});

// ── FILTER PICK ──
function pickFilter(id) {
  activeFilter = id;
  document.querySelectorAll('.filter-pill').forEach(p => p.classList.toggle('active', p.dataset.id === id));
  document.getElementById('activeName').textContent = FILTERS.find(f => f.id === id).name;
  resetSliders();
  if (isMobile()) updateMobileChips(id);
  render();
  if (id !== 'none') showHoldHint();
}

// ── ADJUST PANEL ──
document.getElementById('adjustBtn').addEventListener('click', () => {
  document.getElementById('adjustBtn').classList.toggle('open');
  document.getElementById('sliderPanel').classList.toggle('open');
});

// ── FILE LOAD ──
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => loadFile(e.target.files[0]));
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('over'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('over'); loadFile(e.dataTransfer.files[0]); });

function loadFile(file) {
  if (!file?.type.startsWith('image/')) return;
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => {
    let w = img.naturalWidth, h = img.naturalHeight;
    const MAX = 1600;
    if (w > MAX) { h = Math.round(h * MAX / w); w = MAX; }
    if (h > MAX) { w = Math.round(w * MAX / h); h = MAX; }
    canvas.width = w; canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);
    originalImg = img;
    originalImg._w = w; originalImg._h = h;
    dropZone.classList.add('hidden');
    previewWrap.classList.add('on');
    render();
  };
  img.src = url;
}

// ── CSS BUILDER ──
function buildSliderCSS(sliders) {
  const { b, c, s, e, bl, sh, temp } = sliders;
  let css = '';
  css += `brightness(${1 + (b + e * 0.5) / 100}) `;
  css += `contrast(${1 + c / 100}) `;
  css += `saturate(${1 + s / 100}) `;
  if (temp > 0) { const t = temp/100; css += `sepia(${t*0.18}) hue-rotate(${-t*12}deg) `; }
  else if (temp < 0) { const t = Math.abs(temp)/100; css += `hue-rotate(${t*15}deg) saturate(${1 - t*0.12}) `; }
  if (bl > 0) css += `blur(${bl}px) `;
  if (sh > 0) css += `saturate(${1 + sh*0.003}) contrast(${1 + sh*0.004}) `;
  return css.trim();
}

// Lerp a CSS filter string toward neutral (no filter) based on intensity 0-1
// Parses each function and scales deviation from 1 (for multiplicative) or 0 (for additive)
function scaleFilterCSS(cssStr, intensity) {
  if (intensity >= 1 || !cssStr) return cssStr;
  return cssStr.replace(/([\w-]+)\(([^)]+)\)/g, (match, fn, val) => {
    const num = parseFloat(val);
    const unit = val.replace(/[\d.\-]/g, '').trim();
    // Additive-from-zero: hue-rotate, sepia, grayscale, blur
    const additiveFromZero = ['hue-rotate','sepia','grayscale','blur'];
    // Multiplicative-from-1: brightness, contrast, saturate
    if (additiveFromZero.includes(fn)) {
      return `${fn}(${num * intensity}${unit})`;
    } else {
      // lerp from 1 toward actual value
      const scaled = 1 + (num - 1) * intensity;
      return `${fn}(${scaled}${unit})`;
    }
  });
}

function getFullCSS() {
  const f = FILTERS.find(f => f.id === activeFilter);
  const sliders = getSliders();
  const { intensity } = sliders;
  const rawBase = (f.css && f.css !== '__pixel__') ? f.css : '';
  const scaledBase = scaleFilterCSS(rawBase, intensity);
  const base = scaledBase ? scaledBase + ' ' : '';
  return (base + buildSliderCSS(sliders)).trim();
}

// ── PIXEL FILTERS ──
function applyRoseMilk(imgEl, w, h) {
  ctx.clearRect(0, 0, w, h);
  ctx.filter = 'none';
  ctx.drawImage(imgEl, 0, 0, w, h);
  const id = ctx.getImageData(0, 0, w, h);
  const d = id.data;
  const tR = 255, tG = 184, tB = 198;
  for (let i = 0; i < d.length; i += 4) {
    let r = d[i]*1.06, g = d[i+1]*1.06, b = d[i+2]*1.06;
    r = r*0.93 + 128*0.07; g = g*0.93 + 128*0.07; b = b*0.93 + 128*0.07;
    const sR = 255*(1-(1-r/255)*(1-tR/255));
    const sG = 255*(1-(1-g/255)*(1-tG/255));
    const sB = 255*(1-(1-b/255)*(1-tB/255));
    d[i]   = Math.min(255,Math.max(0, r*0.87 + sR*0.13));
    d[i+1] = Math.min(255,Math.max(0, g*0.87 + sG*0.13));
    d[i+2] = Math.min(255,Math.max(0, b*0.87 + sB*0.13));
  }
  ctx.putImageData(id, 0, 0);
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  tmp.getContext('2d').drawImage(canvas, 0, 0);
  ctx.filter = 'blur(0.8px)';
  ctx.globalAlpha = 0.35;
  ctx.drawImage(tmp, 0, 0);
  ctx.globalAlpha = 1; ctx.filter = 'none';
}

function applySunshine(imgEl, w, h) {
  ctx.clearRect(0, 0, w, h);
  ctx.filter = 'none';
  ctx.drawImage(imgEl, 0, 0, w, h);
  const id = ctx.getImageData(0, 0, w, h);
  const d = id.data;
  // Tint: lemon-beige #fff0c0 (r=255, g=240, b=192) — warm golden light
  const tR = 255, tG = 240, tB = 192;
  for (let i = 0; i < d.length; i += 4) {
    let r = d[i], g = d[i+1], b = d[i+2];

    // 1. Brighten + lift shadows (airy, sun-flooded look)
    r = r * 1.10 + 8;
    g = g * 1.08 + 5;
    b = b * 1.04 + 2;

    // 2. Reduce contrast softly for that hazy feeling
    const cf = 0.91;
    r = r * cf + 128 * (1 - cf);
    g = g * cf + 128 * (1 - cf);
    b = b * cf + 128 * (1 - cf);

    // 3. Screen blend with lemon-beige — adds warmth without yellowing
    const sR = 255*(1-(1-r/255)*(1-tR/255));
    const sG = 255*(1-(1-g/255)*(1-tG/255));
    const sB = 255*(1-(1-b/255)*(1-tB/255));

    // 4. Blend at low strength — just a kiss of golden light
    const str = 0.16;
    r = r*(1-str) + sR*str;
    g = g*(1-str) + sG*str;
    b = b*(1-str) + sB*str;

    d[i]   = Math.min(255, Math.max(0, r));
    d[i+1] = Math.min(255, Math.max(0, g));
    d[i+2] = Math.min(255, Math.max(0, b));
  }
  ctx.putImageData(id, 0, 0);

  // Glowy softness — two layered passes, slight haze
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  tmp.getContext('2d').drawImage(canvas, 0, 0);

  // First pass: wide soft glow (simulates lens flare haze)
  ctx.filter = 'blur(2.5px)';
  ctx.globalAlpha = 0.22;
  ctx.drawImage(tmp, 0, 0);

  // Second pass: tighter warmth bloom
  ctx.filter = 'blur(0.8px) brightness(1.04)';
  ctx.globalAlpha = 0.18;
  ctx.drawImage(tmp, 0, 0);

  ctx.globalAlpha = 1; ctx.filter = 'none';
}

function applyY2KDigi(imgEl, w, h) {
  ctx.clearRect(0, 0, w, h);
  ctx.filter = 'none';
  ctx.drawImage(imgEl, 0, 0, w, h);
  const id = ctx.getImageData(0, 0, w, h);
  const d = id.data;
  for (let i = 0; i < d.length; i += 4) {
    let r = d[i], g = d[i+1], b = d[i+2];
    r = (r-128)*1.05+128; g = (g-128)*1.05+128; b = (b-128)*1.05+128;
    d[i]   = Math.min(255,Math.max(0,r));
    d[i+1] = Math.min(255,Math.max(0,g));
    d[i+2] = Math.min(255,Math.max(0,b));
  }
  ctx.putImageData(id, 0, 0);
  const ghost = document.createElement('canvas');
  ghost.width = w; ghost.height = h;
  ghost.getContext('2d').drawImage(canvas, 0, 0);
  ctx.globalAlpha = 0.38; ctx.drawImage(ghost, 2.5, -0.5);
  ctx.globalAlpha = 0.10; ctx.drawImage(ghost, -1.0, 0.3);
  ctx.globalAlpha = 1; ctx.filter = 'none';
  const nd = ctx.getImageData(0, 0, w, h); const na = nd.data;
  for (let i = 0; i < na.length; i += 4) {
    const n = (Math.random()-0.5)*7;
    na[i]   = Math.min(255,Math.max(0,na[i]+n));
    na[i+1] = Math.min(255,Math.max(0,na[i+1]+n));
    na[i+2] = Math.min(255,Math.max(0,na[i+2]+n));
  }
  ctx.putImageData(nd, 0, 0);
}


function applyDawn(imgEl, w, h) {
  // 새벽: 회색+블루 틴트 스크린 블렌드
  // 틴트 색: #b8cce0 — 차갑고 탁한 블루그레이
  ctx.clearRect(0, 0, w, h);
  ctx.filter = 'none';
  ctx.drawImage(imgEl, 0, 0, w, h);
  const id = ctx.getImageData(0, 0, w, h);
  const d = id.data;
  const tR = 184, tG = 204, tB = 224; // 블루그레이

  for (let i = 0; i < d.length; i += 4) {
    let r = d[i], g = d[i+1], b = d[i+2];

    // 채도 낮추기 — 무채색 쪽으로
    const lum = 0.299*r + 0.587*g + 0.114*b;
    r = r * 0.65 + lum * 0.35;
    g = g * 0.65 + lum * 0.35;
    b = b * 0.65 + lum * 0.35;

    // 약간 밝히고 대비 낮추기 (뿌연 느낌)
    r = r * 1.06 + 6;
    g = g * 1.06 + 6;
    b = b * 1.06 + 6;
    const cf = 0.88;
    r = r*cf + 128*(1-cf);
    g = g*cf + 128*(1-cf);
    b = b*cf + 128*(1-cf);

    // 블루그레이 스크린 블렌드
    const sR = 255*(1-(1-r/255)*(1-tR/255));
    const sG = 255*(1-(1-g/255)*(1-tG/255));
    const sB = 255*(1-(1-b/255)*(1-tB/255));

    const str = 0.20;
    d[i]   = Math.min(255, Math.max(0, r*(1-str) + sR*str));
    d[i+1] = Math.min(255, Math.max(0, g*(1-str) + sG*str));
    d[i+2] = Math.min(255, Math.max(0, b*(1-str) + sB*str));
  }
  ctx.putImageData(id, 0, 0);

  // 살짝 부옇게 — haze 레이어
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  tmp.getContext('2d').drawImage(canvas, 0, 0);
  ctx.filter = 'blur(1.2px)';
  ctx.globalAlpha = 0.28;
  ctx.drawImage(tmp, 0, 0);
  ctx.globalAlpha = 1; ctx.filter = 'none';
}

function applyWinter(imgEl, w, h) {
  // Winter: 청록 틴트 + 대비 올리기
  // 틴트 색: #90d4c8 — 맑은 청록
  ctx.clearRect(0, 0, w, h);
  ctx.filter = 'none';
  ctx.drawImage(imgEl, 0, 0, w, h);
  const id = ctx.getImageData(0, 0, w, h);
  const d = id.data;
  const tR = 144, tG = 212, tB = 200; // 청록

  for (let i = 0; i < d.length; i += 4) {
    let r = d[i], g = d[i+1], b = d[i+2];

    // 대비 올리기
    const cf = 1.18;
    r = (r-128)*cf + 128;
    g = (g-128)*cf + 128;
    b = (b-128)*cf + 128;

    // 청록 멀티플라이 블렌드 (어두운 영역에 색 스며들게)
    // multiply: a*b/255
    const mR = r * tR / 255;
    const mG = g * tG / 255;
    const mB = b * tB / 255;

    // 스크린 블렌드도 살짝 (밝은 쪽에도 청록 기운)
    const sR = 255*(1-(1-r/255)*(1-tR/255));
    const sG = 255*(1-(1-g/255)*(1-tG/255));
    const sB = 255*(1-(1-b/255)*(1-tB/255));

    // overlay처럼: 어두운 픽셀엔 multiply, 밝은 픽셀엔 screen
    const str = 0.18;
    const blendR = r < 128 ? mR : sR;
    const blendG = g < 128 ? mG : sG;
    const blendB = b < 128 ? mB : sB;

    d[i]   = Math.min(255, Math.max(0, r*(1-str) + blendR*str));
    d[i+1] = Math.min(255, Math.max(0, g*(1-str) + blendG*str));
    d[i+2] = Math.min(255, Math.max(0, b*(1-str) + blendB*str));
  }
  ctx.putImageData(id, 0, 0);
}

// ── RENDER ──
function render() {
  if (!originalImg) return;
  const w = originalImg._w, h = originalImg._h;
  const sliders = getSliders();
  const { intensity } = sliders;

  if (PIXEL_FILTERS.includes(activeFilter)) {
    if (intensity >= 1) {
      // Full strength — direct
      if (activeFilter === 'rosemilk') applyRoseMilk(originalImg, w, h);
      if (activeFilter === 'sunshine') applySunshine(originalImg, w, h);
      if (activeFilter === 'dawn')     applyDawn(originalImg, w, h);
      if (activeFilter === 'winter')   applyWinter(originalImg, w, h);
      if (activeFilter === 'y2kdigi')  applyY2KDigi(originalImg, w, h);
    } else {
      // Partial: run filter fully → save → blend with original at intensity
      const orig = document.createElement('canvas');
      orig.width = w; orig.height = h;
      orig.getContext('2d').drawImage(originalImg, 0, 0, w, h);

      if (activeFilter === 'rosemilk') applyRoseMilk(originalImg, w, h);
      if (activeFilter === 'sunshine') applySunshine(originalImg, w, h);
      if (activeFilter === 'dawn')     applyDawn(originalImg, w, h);
      if (activeFilter === 'winter')   applyWinter(originalImg, w, h);
      if (activeFilter === 'y2kdigi')  applyY2KDigi(originalImg, w, h);

      const filtered = document.createElement('canvas');
      filtered.width = w; filtered.height = h;
      filtered.getContext('2d').drawImage(canvas, 0, 0);

      ctx.clearRect(0, 0, w, h);
      ctx.filter = 'none';
      ctx.globalAlpha = 1;
      ctx.drawImage(orig, 0, 0);
      ctx.globalAlpha = intensity;
      ctx.drawImage(filtered, 0, 0);
      ctx.globalAlpha = 1;
    }
    canvas.style.filter = buildSliderCSS(sliders);
  } else {
    ctx.clearRect(0, 0, w, h);
    ctx.filter = 'none';
    ctx.drawImage(originalImg, 0, 0, w, h);
    canvas.style.filter = getFullCSS();
  }
}
// ── BUTTONS ──
document.getElementById('resetBtn').addEventListener('click', () => pickFilter('none'));

document.getElementById('changeBtn').addEventListener('click', () => {
  previewWrap.classList.remove('on');
  dropZone.classList.remove('hidden');
  fileInput.value = '';
  originalImg = null;
  canvas.style.filter = '';
});

document.getElementById('dlBtn').addEventListener('click', () => {
  if (!originalImg) return;
  const w = canvas.width, h = canvas.height;
  const sliders = getSliders();
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  const tCtx = tmp.getContext('2d');

  if (PIXEL_FILTERS.includes(activeFilter)) {
    tCtx.filter = buildSliderCSS(sliders);
    tCtx.drawImage(canvas, 0, 0);
  } else {
    tCtx.filter = getFullCSS();
    tCtx.drawImage(originalImg, 0, 0, w, h);
  }

  const a = document.createElement('a');
  a.download = `camino-${activeFilter}.png`;
  a.href = tmp.toDataURL('image/png');
  a.click();
});

// Init mobile on load + resize
initMobileUI();
window.addEventListener('resize', () => {
  if (isMobile()) {
    document.getElementById('mobileFilterSection').style.display = 'block';
    updateMobileChips(activeFilter);
  } else {
    document.getElementById('mobileFilterSection').style.display = 'none';
  }
});
</script>-e 
</body>
</html>
